<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon de Thé "PALMA" - Calcul de Recette</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #8b4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #666;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #8b4513;
            border: 2px solid #e9ecef;
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            border: 2px solid #8b4513;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-selector {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .date-input {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: 2px solid #8b4513;
            border-radius: 12px;
            outline: none;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }
        
        .date-input:focus {
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2);
        }
        
        .current-date-display {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #8b4513;
            font-weight: 600;
        }
        
        .storage-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: 500;
        }
        
        .storage-error {
            color: #e74c3c;
        }
        
        .session-selector {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .session-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .session-btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #8b4513;
            border: 2px solid #e9ecef;
        }
        
        .session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .session-btn.active {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            border: 2px solid #8b4513;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .product-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #8b4513;
        }
        
        .product-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: #27ae60;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #8b4513;
            background: white;
            color: #8b4513;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quantity-btn:hover {
            background: #8b4513;
            color: white;
        }
        
        .quantity-input {
            width: 60px;
            height: 40px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border: 2px solid #8b4513;
            border-radius: 8px;
            outline: none;
        }
        
        .totals-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin-bottom: 20px;
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .total-card {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .total-label {
            font-size: 1.1rem;
            font-weight: 300;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .total-amount {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .grand-total {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .product-total {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8b4513;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f8f9fa;
        }
        
        /* Action Buttons */
        .action-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .print-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }
        
        .backup-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        /* History Section Styles */
        .history-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .history-title {
            font-size: 1.5rem;
            color: #8b4513;
            font-weight: 700;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #8b4513;
            transition: transform 0.2s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }
        
        .history-date {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8b4513;
            margin-bottom: 10px;
        }
        
        .history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .history-session {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .session-title {
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .session-products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .product-name-history {
            font-weight: 600;
        }
        
        .product-quantity {
            color: #27ae60;
        }
        
        .session-total {
            font-weight: 700;
            color: #2c3e50;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .no-history {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .success-message.show {
            transform: translateX(0);
        }
        
        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #8b4513;
        }
        
        /* Backup/Restore section */
        .backup-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin: 20px 0;
        }
        
        .backup-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .backup-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-top: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        /* Print styles */
        @media print {
            .tabs, .action-section, .tab-btn, .success-message, .container > header, .backup-section {
                display: none !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            .tab-content:not(.active) {
                display: none !important;
            }
            
            .tab-content.active {
                display: block !important;
            }
            
            .product-card, .totals-section, .date-selector, .session-selector {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                padding: 20px;
                border-bottom: 2px solid #8b4513;
            }
            
            .print-header h2 {
                color: #8b4513;
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .session-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .session-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .action-section {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .backup-controls {
                flex-direction: column;
            }
            
            .file-label {
                width: 100%;
                text-align: center;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .date-input {
                width: 100%;
                max-width: 300px;
            }
            
            .history-details {
                grid-template-columns: 1fr;
            }
            
            .success-message {
                top: 60px;
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }
            
            .success-message.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Salon de Thé "PALMA"</h1>
            <p class="subtitle">Calcul de Recette - Matin & Après-Midi</p>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="calculator">Calculatrice</button>
            <button class="tab-btn" data-tab="history">Historique</button>
            <button class="tab-btn" data-tab="backup">Sauvegarde</button>
        </div>
        
        <!-- Calculator Tab -->
        <div class="tab-content active" id="calculator-tab">
            <div class="date-selector">
                <h2>Sélectionner la date</h2>
                <input type="date" class="date-input" id="date-input">
                <div class="current-date-display" id="current-date-display"></div>
                <div class="storage-status" id="storage-status">Données sauvegardées automatiquement dans le navigateur</div>
            </div>
            
            <div class="session-selector">
                <h2>Sélectionner la séance de travail</h2>
                <div class="session-buttons">
                    <button class="session-btn active" data-session="matin">Matin</button>
                    <button class="session-btn" data-session="apres-midi">Après-Midi</button>
                </div>
            </div>
            
            <div class="products-grid" id="products-container">
                <!-- Products will be dynamically inserted here -->
            </div>
            
            <div class="totals-section">
                <h2>Totaux</h2>
                <div class="totals-grid">
                    <div class="total-card">
                        <div class="total-label">Total Matin</div>
                        <div class="total-amount" id="total-matin">0 DT</div>
                    </div>
                    <div class="total-card">
                        <div class="total-label">Total Après-Midi</div>
                        <div class="total-amount" id="total-apres-midi">0 DT</div>
                    </div>
                    <div class="total-card grand-total">
                        <div class="total-label">Total des Deux Séances</div>
                        <div class="total-amount" id="total-general">0 DT</div>
                    </div>
                </div>
            </div>
            
            <div class="action-section">
                <button class="action-btn save-btn" id="save-btn">Enregistrer les Ventes</button>
                <button class="action-btn print-btn" id="print-btn">Imprimer</button>
                <button class="action-btn pdf-btn" id="pdf-btn">Enregistrer en PDF</button>
                <button class="action-btn backup-btn" id="backup-btn">Sauvegarde Manuelle</button>
            </div>
        </div>
        
        <!-- History Tab -->
        <div class="tab-content" id="history-tab">
            <div class="history-section">
                <div class="history-header">
                    <h2 class="history-title">Historique des Ventes</h2>
                </div>
                <div class="history-list" id="history-list">
                    <!-- History items will be dynamically inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Backup Tab -->
        <div class="tab-content" id="backup-tab">
            <div class="backup-section">
                <h2>Options de Sauvegarde et Restauration</h2>
                <p>Cette section vous permet de sauvegarder vos données manuellement et de les restaurer si nécessaire.</p>
                
                <div class="backup-controls">
                    <button class="action-btn backup-btn" id="download-backup-btn">Télécharger la Sauvegarde</button>
                    <label for="restore-file" class="file-label">Restaurer depuis Fichier</label>
                    <input type="file" id="restore-file" class="file-input" accept=".json">
                </div>
                
                <h3 style="margin-top: 20px;">Données de Sauvegarde (copier/coller)</h3>
                <textarea class="backup-textarea" id="backup-data" readonly></textarea>
                
                <div class="backup-controls" style="margin-top: 15px;">
                    <button class="action-btn backup-btn" id="copy-backup-btn">Copier les Données</button>
                    <button class="action-btn" style="background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);" id="restore-from-text-btn">Restaurer depuis Texte</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="success-message" id="success-message">Ventes enregistrées avec succès !</div>

    <script>
        // Product data with prices in Tunisian Dinars (DT)
        const products = [
            { name: 'Express', price: 1800 },
            { name: 'Capucin', price: 2000 },
            { name: 'Direct', price: 2200 },
            { name: 'Eau 1/2', price: 1000 },
            { name: 'Eau 1', price: 1500 },
            { name: 'Goblet', price: 100 },
            { name: 'Thé', price: 1000 },
            { name: 'Boisson', price: 2000 }
        ];
        
        // Sales data storage by date
        let salesDataByDate = {};
        let currentSession = 'matin';
        let currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // DOM elements
        const tabButtons = document.querySelectorAll('.tab-btn');
        const calculatorTab = document.getElementById('calculator-tab');
        const historyTab = document.getElementById('history-tab');
        const backupTab = document.getElementById('backup-tab');
        const dateInput = document.getElementById('date-input');
        const currentDateDisplay = document.getElementById('current-date-display');
        const storageStatus = document.getElementById('storage-status');
        const sessionButtons = document.querySelectorAll('.session-btn');
        const productsContainer = document.getElementById('products-container');
        const totalMatinElement = document.getElementById('total-matin');
        const totalApresMidiElement = document.getElementById('total-apres-midi');
        const totalGeneralElement = document.getElementById('total-general');
        const historyList = document.getElementById('history-list');
        const saveBtn = document.getElementById('save-btn');
        const printBtn = document.getElementById('print-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const backupBtn = document.getElementById('backup-btn');
        const successMessage = document.getElementById('success-message');
        const downloadBackupBtn = document.getElementById('download-backup-btn');
        const restoreFileInput = document.getElementById('restore-file');
        const backupDataTextarea = document.getElementById('backup-data');
        const copyBackupBtn = document.getElementById('copy-backup-btn');
        const restoreFromTextBtn = document.getElementById('restore-from-text-btn');
        
        // Storage mechanism status
        let storageType = 'localStorage';
        let storageAvailable = true;
        
        // Initialize date input with today's date
        dateInput.value = currentDate;
        updateDateDisplay();
        
        // Check storage availability
        function checkStorageAvailability() {
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
                storageType = 'localStorage';
                storageStatus.textContent = `Sauvegarde automatique activée (${storageType})`;
                storageStatus.className = 'storage-status';
            } catch (error) {
                storageAvailable = false;
                storageType = 'none';
                storageStatus.textContent = 'Sauvegarde automatique désactivée (navigateur en mode privé ou bloqué)';
                storageStatus.className = 'storage-status storage-error';
                showWarningMessage('Mode de sauvegarde automatique désactivé. Utilisez la sauvegarde manuelle.');
            }
        }
        
        // Load data from storage
        function loadFromStorage() {
            if (storageAvailable && storageType === 'localStorage') {
                try {
                    const savedData = localStorage.getItem('salon_the_palma_data_v3');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        if (parsedData && typeof parsedData === 'object') {
                            salesDataByDate = parsedData;
                            return true;
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load from localStorage:', error);
                }
            }
            
            // Try to load from URL parameters as fallback
            const urlParams = new URLSearchParams(window.location.search);
            const backupData = urlParams.get('backup');
            if (backupData) {
                try {
                    const parsedData = JSON.parse(atob(backupData));
                    if (parsedData && typeof parsedData === 'object') {
                        salesDataByDate = parsedData;
                        storageType = 'url';
                        storageStatus.textContent = 'Données chargées depuis l\'URL';
                        storageStatus.className = 'storage-status';
                        return true;
                    }
                } catch (error) {
                    console.warn('Failed to load from URL parameters:', error);
                }
            }
            
            return false;
        }
        
        // Save data to storage
        function saveToStorage() {
            if (storageAvailable && storageType === 'localStorage') {
                try {
                    localStorage.setItem('salon_the_palma_data_v3', JSON.stringify(salesDataByDate));
                    return true;
                } catch (error) {
                    console.warn('Failed to save to localStorage:', error);
                    storageAvailable = false;
                    storageType = 'none';
                    storageStatus.textContent = 'Erreur de sauvegarde - utilisez la sauvegarde manuelle';
                    storageStatus.className = 'storage-status storage-error';
                }
            }
            return false;
        }
        
        // Manual backup functions
        function generateBackupData() {
            return JSON.stringify(salesDataByDate, null, 2);
        }
        
        function downloadBackup() {
            const backupData = generateBackupData();
            const blob = new Blob([backupData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `palma_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSuccessMessage('Sauvegarde téléchargée avec succès !');
        }
        
        function restoreFromBackupData(data) {
            try {
                const parsedData = JSON.parse(data);
                if (parsedData && typeof parsedData === 'object') {
                    salesDataByDate = parsedData;
                    saveToStorage();
                    renderProducts();
                    updateTotals();
                    renderHistory();
                    showSuccessMessage('Données restaurées avec succès !');
                    return true;
                }
            } catch (error) {
                console.error('Invalid backup data:', error);
                showErrorMessage('Données de sauvegarde invalides');
            }
            return false;
        }
        
        function copyBackupData() {
            const backupData = generateBackupData();
            backupDataTextarea.value = backupData;
            
            navigator.clipboard.writeText(backupData).then(() => {
                showSuccessMessage('Données de sauvegarde copiées !');
            }).catch(err => {
                console.error('Failed to copy backup data:', err);
                showErrorMessage('Impossible de copier les données');
            });
        }
        
        // Show messages
        function showSuccessMessage(message) {
            successMessage.textContent = message || 'Opération réussie !';
            successMessage.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }
        
        function showErrorMessage(message) {
            successMessage.textContent = message || 'Une erreur est survenue';
            successMessage.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }
        
        function showWarningMessage(message) {
            successMessage.textContent = message || 'Attention';
            successMessage.style.background = 'linear-gradient(135deg, #f39c12 0%, #d35400 100%)';
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }
        
        // Initialize the application
        function init() {
            checkStorageAvailability();
            const loaded = loadFromStorage();
            if (!loaded) {
                // Initialize with empty data if no saved data found
                salesDataByDate = {};
            }
            ensureDateDataExists(currentDate);
            renderProducts();
            updateTotals();
            renderHistory();
            updateBackupDataDisplay();
            setupEventListeners();
        }
        
        // Ensure data exists for the given date
        function ensureDateDataExists(date) {
            if (!salesDataByDate[date]) {
                salesDataByDate[date] = {
                    matin: {},
                    'apres-midi': {}
                };
                
                products.forEach(product => {
                    salesDataByDate[date].matin[product.name] = 0;
                    salesDataByDate[date]['apres-midi'][product.name] = 0;
                });
            }
        }
        
        // Update backup data display
        function updateBackupDataDisplay() {
            backupDataTextarea.value = generateBackupData();
        }
        
        // Get sales data for current date and session
        function getSalesData() {
            return salesDataByDate[currentDate][currentSession];
        }
        
        // Render products grid
        function renderProducts() {
            productsContainer.innerHTML = '';
            
            const salesData = getSalesData();
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const quantity = salesData[product.name];
                const total = quantity * product.price;
                
                productCard.innerHTML = `
                    <div class="product-header">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toLocaleString()} DT</div>
                    </div>
                    <div class="quantity-control">
                        <button class="quantity-btn decrease" data-product="${product.name}">-</button>
                        <input type="number" class="quantity-input" value="${quantity}" min="0" data-product="${product.name}">
                        <button class="quantity-btn increase" data-product="${product.name}">+</button>
                    </div>
                    <div class="product-total">Total: ${total.toLocaleString()} DT</div>
                `;
                
                productsContainer.appendChild(productCard);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const tab = button.dataset.tab;
                    calculatorTab.classList.toggle('active', tab === 'calculator');
                    historyTab.classList.toggle('active', tab === 'history');
                    backupTab.classList.toggle('active', tab === 'backup');
                    
                    if (tab === 'history') {
                        renderHistory();
                    } else if (tab === 'backup') {
                        updateBackupDataDisplay();
                    }
                });
            });
            
            // Date input change
            dateInput.addEventListener('change', () => {
                currentDate = dateInput.value;
                updateDateDisplay();
                ensureDateDataExists(currentDate);
                renderProducts();
                updateTotals();
                if (storageAvailable) saveToStorage();
            });
            
            // Session buttons
            sessionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    sessionButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentSession = button.dataset.session;
                    renderProducts();
                });
            });
            
            // Quantity controls (using event delegation)
            productsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('decrease') || e.target.classList.contains('increase')) {
                    const productName = e.target.dataset.product;
                    const input = document.querySelector(`input[data-product="${productName}"]`);
                    let value = parseInt(input.value) || 0;
                    
                    if (e.target.classList.contains('increase')) {
                        value++;
                    } else if (e.target.classList.contains('decrease') && value > 0) {
                        value--;
                    }
                    
                    input.value = value;
                    salesDataByDate[currentDate][currentSession][productName] = value;
                    renderProducts();
                    updateTotals();
                    if (storageAvailable) saveToStorage();
                    updateBackupDataDisplay();
                }
            });
            
            // Quantity input changes
            productsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    const productName = e.target.dataset.product;
                    let value = parseInt(e.target.value) || 0;
                    
                    if (value < 0) value = 0;
                    e.target.value = value;
                    salesDataByDate[currentDate][currentSession][productName] = value;
                    renderProducts();
                    updateTotals();
                    if (storageAvailable) saveToStorage();
                    updateBackupDataDisplay();
                }
            });
            
            // Save button
            saveBtn.addEventListener('click', () => {
                if (storageAvailable) {
                    saveToStorage();
                    showSuccessMessage('Données enregistrées dans le navigateur');
                } else {
                    showWarningMessage('Sauvegarde automatique désactivée. Utilisez la sauvegarde manuelle.');
                }
                renderHistory();
            });
            
            // Backup button
            backupBtn.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="backup"]').classList.add('active');
                calculatorTab.classList.remove('active');
                backupTab.classList.add('active');
                updateBackupDataDisplay();
            });
            
            // Print button
            printBtn.addEventListener('click', () => {
                printRecap();
            });
            
            // PDF button
            pdfBtn.addEventListener('click', () => {
                generatePDF();
            });
            
            // Download backup button
            downloadBackupBtn.addEventListener('click', () => {
                downloadBackup();
            });
            
            // Restore from file
            restoreFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        restoreFromBackupData(event.target.result);
                        restoreFileInput.value = '';
                    };
                    reader.onerror = function() {
                        showErrorMessage('Erreur lors de la lecture du fichier');
                    };
                    reader.readAsText(file);
                }
            });
            
            // Copy backup button
            copyBackupBtn.addEventListener('click', () => {
                copyBackupData();
            });
            
            // Restore from text button
            restoreFromTextBtn.addEventListener('click', () => {
                const backupData = backupDataTextarea.value;
                if (backupData) {
                    restoreFromBackupData(backupData);
                } else {
                    showErrorMessage('Aucune donnée à restaurer');
                }
            });
        }
        
        // Update date display
        function updateDateDisplay() {
            const date = new Date(currentDate);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('fr-FR', options);
            currentDateDisplay.textContent = `Date sélectionnée: ${formattedDate}`;
        }
        
        // Update totals display
        function updateTotals() {
            ensureDateDataExists(currentDate);
            
            let totalMatin = 0;
            let totalApresMidi = 0;
            
            products.forEach(product => {
                totalMatin += salesDataByDate[currentDate].matin[product.name] * product.price;
                totalApresMidi += salesDataByDate[currentDate]['apres-midi'][product.name] * product.price;
            });
            
            const totalGeneral = totalMatin + totalApresMidi;
            
            totalMatinElement.textContent = totalMatin.toLocaleString() + ' DT';
            totalApresMidiElement.textContent = totalApresMidi.toLocaleString() + ' DT';
            totalGeneralElement.textContent = totalGeneral.toLocaleString() + ' DT';
        }
        
        // Print functionality
        function printRecap() {
            const printWindow = window.open('', '_blank');
            const dateObj = new Date(currentDate);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('fr-FR', options);
            
            let printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Recap Salon de Thé PALMA - ${formattedDate}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #8b4513; }
                        .date { font-size: 18px; margin: 15px 0; }
                        .section { margin: 20px 0; }
                        .products { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                        .product { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        .totals { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-top: 20px; }
                        .total-row { display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; }
                        .grand-total { background: #27ae60; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 20px; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Salon de Thé "PALMA"</h1>
                        <div class="date">Récapitulatif du ${formattedDate}</div>
                    </div>
                    
                    <div class="section">
                        <h2>Produits Vendus</h2>
                        <div class="products">
            `;
            
            // Add morning session products
            printContent += '<div class="product"><h3>Séance Matin</h3>';
            let hasMorningSales = false;
            products.forEach(product => {
                const quantity = salesDataByDate[currentDate].matin[product.name];
                if (quantity > 0) {
                    hasMorningSales = true;
                    printContent += `<div>${product.name}: ${quantity} (${(quantity * product.price).toLocaleString()} DT)</div>`;
                }
            });
            if (!hasMorningSales) {
                printContent += '<div>Aucune vente</div>';
            }
            printContent += '</div>';
            
            // Add afternoon session products
            printContent += '<div class="product"><h3>Séance Après-Midi</h3>';
            let hasAfternoonSales = false;
            products.forEach(product => {
                const quantity = salesDataByDate[currentDate]['apres-midi'][product.name];
                if (quantity > 0) {
                    hasAfternoonSales = true;
                    printContent += `<div>${product.name}: ${quantity} (${(quantity * product.price).toLocaleString()} DT)</div>`;
                }
            });
            if (!hasAfternoonSales) {
                printContent += '<div>Aucune vente</div>';
            }
            printContent += '</div>';
            
            printContent += `
                        </div>
                    </div>
                    
                    <div class="totals">
                        <h2>Totaux</h2>
                        <div class="total-row">
                            <span>Total Matin:</span>
                            <span>${calculateTotal('matin').toLocaleString()} DT</span>
                        </div>
                        <div class="total-row">
                            <span>Total Après-Midi:</span>
                            <span>${calculateTotal('apres-midi').toLocaleString()} DT</span>
                        </div>
                    </div>
                    
                    <div class="grand-total">
                        Total Général: ${(calculateTotal('matin') + calculateTotal('apres-midi')).toLocaleString()} DT
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
        
        // Calculate total for a session
        function calculateTotal(session) {
            let total = 0;
            products.forEach(product => {
                total += salesDataByDate[currentDate][session][product.name] * product.price;
            });
            return total;
        }
        
        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // Create new PDF
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.width;
            const pageHeight = pdf.internal.pageSize.height;
            
            // Header
            pdf.setFontSize(20);
            pdf.setTextColor(139, 69, 19);
            pdf.text('Salon de Thé "PALMA"', pageWidth / 2, 20, { align: 'center' });
            
            const dateObj = new Date(currentDate);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('fr-FR', options);
            
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Récapitulatif du ${formattedDate}`, pageWidth / 2, 30, { align: 'center' });
            
            let yPosition = 45;
            
            // Morning session
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Séance Matin', 20, yPosition);
            yPosition += 10;
            
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            let hasMorningSales = false;
            products.forEach(product => {
                const quantity = salesDataByDate[currentDate].matin[product.name];
                if (quantity > 0) {
                    hasMorningSales = true;
                    const line = `${product.name}: ${quantity} × ${product.price.toLocaleString()} DT = ${(quantity * product.price).toLocaleString()} DT`;
                    pdf.text(line, 25, yPosition);
                    yPosition += 7;
                }
            });
            
            if (!hasMorningSales) {
                pdf.text('Aucune vente', 25, yPosition);
                yPosition += 7;
            }
            
            yPosition += 5;
            
            // Afternoon session
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Séance Après-Midi', 20, yPosition);
            yPosition += 10;
            
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            let hasAfternoonSales = false;
            products.forEach(product => {
                const quantity = salesDataByDate[currentDate]['apres-midi'][product.name];
                if (quantity > 0) {
                    hasAfternoonSales = true;
                    const line = `${product.name}: ${quantity} × ${product.price.toLocaleString()} DT = ${(quantity * product.price).toLocaleString()} DT`;
                    pdf.text(line, 25, yPosition);
                    yPosition += 7;
                }
            });
            
            if (!hasAfternoonSales) {
                pdf.text('Aucune vente', 25, yPosition);
                yPosition += 7;
            }
            
            yPosition += 10;
            
            // Totals
            const totalMatin = calculateTotal('matin');
            const totalApresMidi = calculateTotal('apres-midi');
            const totalGeneral = totalMatin + totalApresMidi;
            
            pdf.setFillColor(230, 230, 230);
            pdf.rect(15, yPosition, pageWidth - 30, 30, 'F');
            pdf.setFont('helvetica', 'bold');
            pdf.text('TOTAUX', pageWidth / 2, yPosition + 8, { align: 'center' });
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Total Matin: ${totalMatin.toLocaleString()} DT`, 20, yPosition + 15);
            pdf.text(`Total Après-Midi: ${totalApresMidi.toLocaleString()} DT`, 20, yPosition + 22);
            pdf.text(`Total Général: ${totalGeneral.toLocaleString()} DT`, pageWidth - 20, yPosition + 28, { align: 'right' });
            
            // Save PDF
            pdf.save(`recap-palma-${currentDate}.pdf`);
            
            showSuccessMessage();
        }
        
        // Render history
        function renderHistory() {
            // Sort dates in descending order (newest first)
            const sortedDates = Object.keys(salesDataByDate).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                historyList.innerHTML = '<div class="no-history">Aucune donnée dans l\'historique</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            sortedDates.forEach(date => {
                const dateData = salesDataByDate[date];
                const dateObj = new Date(date);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = dateObj.toLocaleDateString('fr-FR', options);
                
                // Calculate totals for this date
                let totalMatin = 0;
                let totalApresMidi = 0;
                
                products.forEach(product => {
                    totalMatin += dateData.matin[product.name] * product.price;
                    totalApresMidi += dateData['apres-midi'][product.name] * product.price;
                });
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // Build products list for matin
                let matinProductsHtml = '';
                products.forEach(product => {
                    if (dateData.matin[product.name] > 0) {
                        matinProductsHtml += `
                            <div class="product-item">
                                <span class="product-name-history">${product.name}</span>
                                <span class="product-quantity">${dateData.matin[product.name]} (${(dateData.matin[product.name] * product.price).toLocaleString()} DT)</span>
                            </div>
                        `;
                    }
                });
                
                // Build products list for après-midi
                let apresMidiProductsHtml = '';
                products.forEach(product => {
                    if (dateData['apres-midi'][product.name] > 0) {
                        apresMidiProductsHtml += `
                            <div class="product-item">
                                <span class="product-name-history">${product.name}</span>
                                <span class="product-quantity">${dateData['apres-midi'][product.name]} (${(dateData['apres-midi'][product.name] * product.price).toLocaleString()} DT)</span>
                            </div>
                        `;
                    }
                });
                
                historyItem.innerHTML = `
                    <div class="history-date">${formattedDate}</div>
                    <div class="history-details">
                        <div class="history-session">
                            <div class="session-title">Séance Matin</div>
                            <div class="session-products">
                                ${matinProductsHtml || '<div class="product-item">Aucune vente</div>'}
                            </div>
                            <div class="session-total">Total Matin: ${totalMatin.toLocaleString()} DT</div>
                        </div>
                        <div class="history-session">
                            <div class="session-title">Séance Après-Midi</div>
                            <div class="session-products">
                                ${apresMidiProductsHtml || '<div class="product-item">Aucune vente</div>'}
                            </div>
                            <div class="session-total">Total Après-Midi: ${totalApresMidi.toLocaleString()} DT</div>
                        </div>
                    </div>
                    <div class="session-total" style="margin-top: 15px; font-size: 1.2rem;">
                        Total Journée: ${(totalMatin + totalApresMidi).toLocaleString()} DT
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

